{
  "kind": "build_request",
  "title": "Fix Motoko canister HTTP routing to return JSON endpoints with CORS (disable HTML fallback)",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-11",
      "text": "Implement the Internet Computer HTTP interface in `backend/main.mo` by adding a public query function `public query func http_request(req : HttpRequest) : async HttpResponse` that performs routing based on `req.method` and the URL path parsed from `req.url` (ignore any query string).",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "1) W głównym actorze (np. main.mo) dodaj publiczną funkcję query:\n   public query func http_request(req : HttpRequest) : async HttpResponse",
          "2) W tej funkcji zrób routing po ścieżce URL (ignoruj query string)"
        ]
      },
      "acceptanceCriteria": [
        "`backend/main.mo` exports `http_request` as a `public query` method with the signature `http_request(req : HttpRequest) : async HttpResponse`.",
        "Routing uses only the URL path (anything after `?` in `req.url` is ignored for route matching)."
      ]
    },
    {
      "id": "REQ-12",
      "text": "In `http_request`, implement method+path routing exactly as follows: (a) if `req.method == \"OPTIONS\"`, return HTTP 204 with an empty body; (b) if `req.method == \"GET\"` and path is `/health`, return HTTP 200 with JSON body `{\"ok\":true}`; (c) if `GET` and path is `/auth/google/start`, return HTTP 200 with JSON body `{\"ok\":true,\"message\":\"google start reached\"}`; (d) if `GET` and path is `/auth/google/callback`, return HTTP 200 with JSON body `{\"ok\":true,\"message\":\"google callback reached\"}`; (e) otherwise return HTTP 404 with JSON body `{\"error\":\"not_found\"}`.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "- jeśli req.method == \"OPTIONS\" -> zwróć 204 + CORS\n   - jeśli GET i path == \"/health\" -> JSON 200 {\"ok\":true}\n   - jeśli GET i path == \"/auth/google/start\" -> JSON 200 {\"ok\":true,\"message\":\"google start reached\"}\n   - jeśli GET i path == \"/auth/google/callback\" -> JSON 200 {\"ok\":true,\"message\":\"google callback reached\"}\n   - dla reszty -> JSON 404 {\"error\":\"not_found\"}"
        ]
      },
      "acceptanceCriteria": [
        "`OPTIONS` requests for any path return status 204 and an empty response body.",
        "`GET /health` returns status 200 with body exactly `{\"ok\":true}` (JSON).",
        "`GET /auth/google/start` returns status 200 with body exactly `{\"ok\":true,\"message\":\"google start reached\"}` (JSON).",
        "`GET /auth/google/callback` returns status 200 with body exactly `{\"ok\":true,\"message\":\"google callback reached\"}` (JSON).",
        "Any other method/path returns status 404 with body exactly `{\"error\":\"not_found\"}` (JSON)."
      ]
    },
    {
      "id": "REQ-13",
      "text": "Add the following CORS headers to every `http_request` response (including 204 and 404): `Access-Control-Allow-Origin: *`, `Access-Control-Allow-Methods: GET,POST,PUT,OPTIONS`, `Access-Control-Allow-Headers: Content-Type, Authorization, X-ADMIN-TOKEN`.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "3) Dodaj nagłówki CORS do KAŻDEJ odpowiedzi:\n   Access-Control-Allow-Origin: *\n   Access-Control-Allow-Methods: GET,POST,PUT,OPTIONS\n   Access-Control-Allow-Headers: Content-Type, Authorization, X-ADMIN-TOKEN"
        ]
      },
      "acceptanceCriteria": [
        "Every response returned by `http_request` includes all three specified CORS headers.",
        "CORS headers are present on `OPTIONS` 204 responses as well as all JSON 200/404 responses."
      ]
    },
    {
      "id": "REQ-14",
      "text": "Disable/remove the HTML landing page response from the canister HTTP handler so that no path returns an HTML page; non-matching routes must return the JSON 404 response instead.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "4) Usuń/wyłącz serwowanie HTML landing page (na razie).\n   Priorytet: endpointy mają działać.",
          "Obecnie niezależnie od ścieżki backend zwraca stronę HTML (\"Professional Dart Scoring API\"),\nczyli http routing nie jest podpięty."
        ]
      },
      "acceptanceCriteria": [
        "Visiting `https://dart-scoring-backend-vab.caffeine.xyz/health` returns JSON and does not render an HTML page.",
        "Visiting `https://dart-scoring-backend-vab.caffeine.xyz/auth/google/start` returns JSON and does not render an HTML page.",
        "Any non-matching path returns JSON 404 `{\"error\":\"not_found\"}` and does not return HTML."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor (all logic in `backend/main.mo`).",
    "Do not edit any frontend immutable paths (not needed for this change)."
  ],
  "nonGoals": [
    "Implementing real Google OAuth (these endpoints are only stub JSON responses).",
    "Adding any new frontend UI changes.",
    "Adding additional HTTP endpoints beyond those explicitly specified."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}