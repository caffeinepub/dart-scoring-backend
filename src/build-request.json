{
  "kind": "build_request",
  "title": "Fix Motoko canister HTTP routing by method+path (JSON endpoints + CORS + OPTIONS) with HTML fallback",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-6",
      "text": "Implement or fix the canister HTTP request handler (`http_request` as a `query`) in `backend/main.mo` so it routes based on `req.method` and the URL path parsed from `req.url` (ignore any query string).",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-6"
        ],
        "quotes": [
          "Zaimplementuj (lub popraw) funkcję HTTP request handler (http_request / query),\nktóra czyta:\n- req.method\n- req.url (ścieżka)"
        ]
      },
      "acceptanceCriteria": [
        "`backend/main.mo` exports a `public query func http_request(req : HttpRequest) : async HttpResponse` compatible with the IC HTTP interface.",
        "The handler uses both `req.method` and the path component of `req.url` for routing (e.g., `/auth/google/start` routes even if `?x=y` is present)."
      ]
    },
    {
      "id": "REQ-7",
      "text": "Add HTTP routing for the following endpoints in the Motoko HTTP handler:\n- `GET /health` returns `200` JSON body `{\"ok\": true}`\n- `GET /auth/google/start` returns `200` JSON body `{\"ok\": true, \"message\": \"google start reached\"}`\n- `GET /auth/google/callback` returns `200` JSON body `{\"ok\": true, \"message\": \"google callback reached\"}`",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-6"
        ],
        "quotes": [
          "Dodaj routing:\n- GET /health -> zwróć JSON 200: {\"ok\": true}\n- GET /auth/google/start -> zwróć JSON 200: {\"ok\": true, \"message\": \"google start reached\"}\n- GET /auth/google/callback -> zwróć JSON 200: {\"ok\": true, \"message\": \"google callback reached\"}"
        ]
      },
      "acceptanceCriteria": [
        "Requesting `GET /health` returns HTTP 200 with `Content-Type: application/json` and body exactly representing the specified JSON.",
        "Requesting `GET /auth/google/start` returns HTTP 200 with `Content-Type: application/json` and the specified JSON payload.",
        "Requesting `GET /auth/google/callback` returns HTTP 200 with `Content-Type: application/json` and the specified JSON payload.",
        "Visiting `https://dart-scoring-backend-vab.caffeine.xyz/auth/google/start` shows JSON (not the HTML landing page)."
      ]
    },
    {
      "id": "REQ-8",
      "text": "For all other HTTP paths (non-matching routes), continue returning the existing HTML landing page response (status 200, `Content-Type: text/html`).",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-6"
        ],
        "quotes": [
          "Dla wszystkich innych ścieżek możesz dalej zwracać HTML landing page."
        ]
      },
      "acceptanceCriteria": [
        "Any `GET` request to an unknown path (e.g., `/`, `/unknown`) returns HTML landing page content (not JSON).",
        "The new JSON routes do not regress the HTML fallback for other paths."
      ]
    },
    {
      "id": "REQ-9",
      "text": "Add CORS headers to all JSON responses returned by the Motoko HTTP handler:\n- `Access-Control-Allow-Origin: *`\n- `Access-Control-Allow-Methods: GET,POST,PUT,OPTIONS`\n- `Access-Control-Allow-Headers: Content-Type, Authorization, X-ADMIN-TOKEN`",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-6"
        ],
        "quotes": [
          "Dodaj CORS do odpowiedzi JSON:\nAccess-Control-Allow-Origin: *\nAccess-Control-Allow-Methods: GET,POST,PUT,OPTIONS\nAccess-Control-Allow-Headers: Content-Type, Authorization, X-ADMIN-TOKEN"
        ]
      },
      "acceptanceCriteria": [
        "Each JSON endpoint response includes all three specified CORS headers with exactly the specified values."
      ]
    },
    {
      "id": "REQ-10",
      "text": "Handle `OPTIONS` requests for any path in the Motoko HTTP handler by returning status `204` with the specified CORS headers and an empty body.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-6"
        ],
        "quotes": [
          "Obsłuż OPTIONS dla dowolnej ścieżki: zwróć 204 + nagłówki CORS."
        ]
      },
      "acceptanceCriteria": [
        "Any `OPTIONS` request (e.g., `OPTIONS /health`, `OPTIONS /anything`) returns HTTP 204 with an empty body.",
        "The `OPTIONS` response includes `Access-Control-Allow-Origin`, `Access-Control-Allow-Methods`, and `Access-Control-Allow-Headers` with the exact specified values."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor in `backend/main.mo` (no additional backend services).",
    "Only create `backend/migration.mo` if a state migration is required; this change should not require any stable-state migration."
  ],
  "nonGoals": [
    "Implementing real Google OAuth flow (tokens, redirects, exchanging codes) beyond returning the requested JSON test payloads.",
    "Adding new frontend routes or changing the React landing page UI."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}